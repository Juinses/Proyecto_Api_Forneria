{% extends 'base.html' %}
{% load static %}

{% block content %}

<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

<style>
  html, body { height:100%; min-height:100vh; margin:0; padding:0; }

  body {
    background-image: url("{% static 'images/fondo_laforner√≠a.jpg' %}"),
                      url("{% static 'images/fondo_laforner√≠a.jpg' %}");
    background-size: cover, cover;
    background-repeat: no-repeat, no-repeat;
    background-position: top center, top center;
    background-attachment: fixed, fixed;
    background-color: #111;
  }

  .product-card { cursor:pointer; transition:0.1s; }
  .product-card:hover { transform: scale(1.02); box-shadow:0 0.25rem 0.5rem rgba(0,0,0,.1); }
  .ticket-sidebar { background:#fff; border-radius:.75rem; box-shadow:0 0.25rem 0.5rem rgba(0,0,0,.1); }
  .vh-90 { height:90vh; }
  .category-btn.active { background:#198754; color:#fff; }
</style>

<div class="p-3">

<!-- üü¶ Encabezado superior -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3><i class="bi bi-shop"></i> La Forner√≠a ¬∑ POS</h3>
  <div>
    <b>Fecha:</b> <span id="fecha"></span> |
    <b>Hora:</b> <span id="hora"></span> |
  </div>
</div>

<div class="row">

  <!-- üü© Productos -->
  <div class="col-lg-8">

      <!-- Buscador -->
      <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="search" type="text" class="form-control" placeholder="Buscar producto...">
      </div>

      <!-- C√≥digo -->
      <div class="input-group mb-3">
          <span class="input-group-text"><i class="bi bi-upc-scan"></i></span>
          <input id="codigoInput" type="text" class="form-control" placeholder="C√≥digo del producto">
          <button class="btn btn-primary" id="btnBuscarCodigo">Agregar</button>
      </div>

      <div class="row g-3" id="product-list"></div>
  </div>

  <!-- üü• Carrito -->
  <div class="col-lg-4">
      <div class="ticket-sidebar p-3">

          <h4 class="mb-3">Carrito</h4>

          <table class="table table-sm">
              <thead>
                  <tr>
                      <th>C√≥digo</th>
                      <th>Nombre</th>
                      <th>Cant.</th>
                      <th>Subt.</th>
                      <th></th>
                  </tr>
              </thead>
              <tbody id="carritoBody"></tbody>
          </table>

          <hr>

          <div><b>Neto:</b> $<span id="neto">0</span></div>
          <div><b>IVA (19%):</b> $<span id="iva">0</span></div>
          <div class="fs-4"><b>Total:</b> $<span id="total">0</span></div>

          <hr>

          <h5>M√©todo de pago</h5>
          <select class="form-select mb-2" id="metodoPago">
              <option value="efectivo">Efectivo</option>
              <option value="debito">D√©bito</option>
              <option value="credito">Cr√©dito</option>
              <option value="mixto">Mixto</option>
          </select>

          <div id="montosPago">
              <input type="number" id="montoEfectivo" class="form-control mb-2 d-none" placeholder="Monto en efectivo">
              <input type="number" id="montoDebito" class="form-control mb-2 d-none" placeholder="Monto en d√©bito">
              <input type="number" id="montoCredito" class="form-control mb-2 d-none" placeholder="Monto en cr√©dito">
          </div>

          <button class="btn btn-success w-100 mt-3" id="btnPagar">
              <i class="bi bi-cash-coin"></i> Pagar
          </button>

      </div>
  </div>

</div>
</div>
<!-- ‚úî Scripts de Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>


<script>
// üü¢ LISTA DE PRODUCTOS (simulaci√≥n sin backend)
const productos = [
    {codigo:"101", nombre:"Pancito", precio:1200},
    {codigo:"102", nombre:"Hallulla", precio:700},
    {codigo:"103", nombre:"Focaccia", precio:1500},
    {codigo:"104", nombre:"Ciabatta", precio:1400},
    {codigo:"345", nombre:"Coca-Cola", precio:2900}
];

// ‚úî Referencias a elementos HTML
const productList = document.getElementById("product-list");
const search = document.getElementById("search");
const carritoBody = document.getElementById("carritoBody");

// ‚úî Array donde se guarda el carrito
let carrito = [];


// üü¶ FUNCION PARA ACTUALIZAR FECHA Y HORA EN TIEMPO REAL
function updateDateTime(){
    const now = new Date();
    document.getElementById("fecha").textContent = now.toLocaleDateString();
    document.getElementById("hora").textContent = now.toLocaleTimeString();
}
setInterval(updateDateTime, 1000);
updateDateTime();


// üü© FUNCION QUE DIBUJA LOS PRODUCTOS EN PANTALLA
function renderProductos(filtro=""){
    productList.innerHTML = "";

    productos
        // ‚úî Filtra por nombre si el usuario escribe en el buscador
        .filter(p => p.nombre.toLowerCase().includes(filtro.toLowerCase()))
        // ‚úî Crea una tarjeta por cada producto
        .forEach(p => {
            const col = document.createElement("div");
            col.className = "col-6 col-md-4 col-xl-3";

            col.innerHTML = `
                <div class="card product-card p-2" data-codigo="${p.codigo}">
                    <h6>${p.nombre}</h6>
                    <p class="text-muted m-0">C√≥digo: ${p.codigo}</p>
                    <span class="fw-bold">$${p.precio.toLocaleString("es-CL")}</span>
                </div>
            `;

            // ‚úî Agregar al carrito con click
            col.querySelector(".product-card").onclick = () => agregarCarrito(p.codigo);

            productList.appendChild(col);
        });
}
renderProductos();

// ‚úî Buscador en tiempo real
search.oninput = () => renderProductos(search.value);


// üü• AGREGAR POR C√ìDIGO
document.getElementById("btnBuscarCodigo").onclick = () => {
    const codigo = document.getElementById("codigoInput").value;
    agregarCarrito(codigo);
};


// üü• A√ëADIR AL CARRITO
function agregarCarrito(codigo){
    const producto = productos.find(p=>p.codigo==codigo);

    // ‚úî Si el producto no existe, avisa
    if(!producto){ alert("C√≥digo no encontrado"); return; }

    // ‚úî Si ya existe en carrito ‚Üí suma cantidad
    let item = carrito.find(i=>i.codigo==codigo);
    if(item){
        item.cantidad++;
    } else {
        carrito.push({...producto, cantidad:1});
    }

    renderCarrito();
}


// üü• DIBUJAR CARRITO
function renderCarrito(){
    carritoBody.innerHTML = "";

    carrito.forEach(item => {
        const fila = document.createElement("tr");

        fila.innerHTML = `
            <td>${item.codigo}</td>
            <td>${item.nombre}</td>
            <td>
                <input type="number" min="1" value="${item.cantidad}" class="form-control form-control-sm edit-qty">
            </td>
            <td>$${(item.precio * item.cantidad).toLocaleString("es-CL")}</td>
            <td>
                <button class="btn btn-sm btn-danger"><i class="bi bi-x"></i></button>
            </td>
        `;

        // ‚úî Editar cantidad
        fila.querySelector("input").oninput = e => {
            item.cantidad = Number(e.target.value);
            renderCarrito();
        };

        // ‚úî Eliminar producto del carrito
        fila.querySelector("button").onclick = () => {
            carrito = carrito.filter(x=>x.codigo != item.codigo);
            renderCarrito();
        };

        carritoBody.appendChild(fila);
    });

    calcularTotales();
}


// üßÆ CALCULA NETO, IVA Y TOTAL
function calcularTotales(){
    const neto = carrito.reduce((sum,i)=>sum+i.precio*i.cantidad,0);
    const iva = Math.round(neto * 0.19);
    const total = neto + iva;

    document.getElementById("neto").textContent = neto.toLocaleString("es-CL");
    document.getElementById("iva").textContent = iva.toLocaleString("es-CL");
    document.getElementById("total").textContent = total.toLocaleString("es-CL");
}


// üü® CAMPOS DE M√âTODO DE PAGO
document.getElementById("metodoPago").onchange = actualizarCamposPago;

function actualizarCamposPago(){
    const metodo = this.value;

    // ‚úî Campos disponibles
    const campos = {
        efectivo: document.getElementById("montoEfectivo"),
        debito:   document.getElementById("montoDebito"),
        credito:  document.getElementById("montoCredito")
    };

    // ‚úî Oculta todos
    Object.values(campos).forEach(c=>c.classList.add("d-none"));

    // ‚úî Muestra seg√∫n m√©todo
    if(metodo=="efectivo") campos.efectivo.classList.remove("d-none");
    if(metodo=="debito")   campos.debito.classList.remove("d-none");
    if(metodo=="credito")  campos.credito.classList.remove("d-none");
    if(metodo=="mixto")    Object.values(campos).forEach(c=>c.classList.remove("d-none"));
}
actualizarCamposPago();


// üü¢ BOT√ìN PAGAR (solo front-end)
document.getElementById("btnPagar").onclick = () => {
    if(carrito.length === 0){
        alert("El carrito est√° vac√≠o");
        return;
    }
    alert("Pago registrado (solo front-end)");
};
</script>

{% endblock %}
